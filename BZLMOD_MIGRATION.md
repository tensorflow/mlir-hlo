# Bzlmod Migration Guide

This repository has been migrated to use Bazel's bzlmod system with Bazel version 7.6.1.

## What Changed

### Bazel Version
- Updated `.bazelversion` files to 7.6.1 for both root and stablehlo workspaces

### Module Configuration
- Added `MODULE.bazel` files for both root (mlir-hlo) and stablehlo workspaces
- Configured module dependencies from Bazel Central Registry:
  - `bazel_skylib` (1.3.0)
  - `rules_cc` (0.0.9)
  - `rules_python` (0.30.0)
  - `rules_shell` (0.2.0)
  - `apple_support` (1.5.0)
  - `zlib` (1.3.1.bcr.3) - Used by LLVM
  - `zstd` (1.5.6) - Used by LLVM

### LLVM Dependencies (Hybrid Approach)
Since LLVM doesn't support bzlmod natively, we use `WORKSPACE.bzlmod` files to manage the LLVM project dependency:
- `llvm-raw`: The raw LLVM source archive
- `llvm-project`: Configured LLVM project via `llvm_configure`

Note: `zlib` and `zstd` are now managed through the Bazel Central Registry (BCR) in MODULE.bazel files with repo_name mappings (`llvm_zlib` and `llvm_zstd`) for LLVM compatibility.

### File Structure
```
mlir-hlo/
├── .bazelversion (7.6.1)
├── MODULE.bazel (bzlmod dependencies)
├── WORKSPACE.bzlmod (LLVM dependencies)
├── WORKSPACE (kept for compatibility)
├── .gitignore (excludes MODULE.bazel.lock files)
└── stablehlo/
    ├── .bazelversion (7.6.1)
    ├── MODULE.bazel (bzlmod dependencies)
    ├── WORKSPACE.bzlmod (LLVM dependencies)
    └── WORKSPACE.bazel (kept for compatibility)
```

### Lock Files
`MODULE.bazel.lock` files are generated by Bazel to ensure reproducible builds but are excluded from version control via `.gitignore`. They will be regenerated automatically when you run Bazel commands.

## Building

The migration is transparent to users. Build commands remain the same:

```bash
# From root workspace
bazel build //path/to:target

# From stablehlo workspace
cd stablehlo && bazel build //:target
```

## Benefits of Bzlmod

1. **Dependency Management**: Automatic version resolution through Bazel Central Registry
2. **Better Isolation**: Each workspace can have its own module configuration
3. **Reproducibility**: MODULE.bazel.lock files ensure reproducible builds
4. **Future-proof**: Bzlmod is the default in Bazel 7.x and beyond
5. **Centralized Dependencies**: Common dependencies like zlib and zstd are managed through BCR

## Hybrid Approach

We use a hybrid approach (bzlmod + WORKSPACE.bzlmod) because:
- LLVM doesn't have a MODULE.bazel file
- WORKSPACE.bzlmod is the recommended way to handle non-bzlmod dependencies in Bazel 7.x
- This allows gradual migration as more dependencies adopt bzlmod
- Common dependencies (zlib, zstd) are managed through BCR when possible

## Verification

To verify the migration:

```bash
# Check Bazel version
bazel --version  # Should show 7.6.1

# View module dependency graph
bazel mod graph

# Test LLVM dependency resolution
bazel build --nobuild @llvm-project//llvm:Support
```
