// RUN: stablehlo-opt -inline %s | stablehlo-translate --interpret
// RUN: stablehlo-translate --serialize --target=current %s | stablehlo-translate --deserialize | stablehlo-opt > %t.0
// RUN: stablehlo-opt %s > %t.1
// RUN: diff %t.0 %t.1

module @jit_main attributes {mhlo.num_partitions = 1 : i32, mhlo.num_replicas = 1 : i32} {
  func.func public @main() -> (tensor<8x9xcomplex<f64>> {jax.result_info = "", mhlo.layout_mode = "default"}) {
    %0 = call @inputs() : () -> tensor<8x9xcomplex<f64>>
    %1 = call @expected() : () -> tensor<8x9xcomplex<f64>>
    %2 = call @cumsum(%0) : (tensor<8x9xcomplex<f64>>) -> tensor<8x9xcomplex<f64>>
    stablehlo.custom_call @check.expect_almost_eq(%2, %1) {has_side_effect = true} : (tensor<8x9xcomplex<f64>>, tensor<8x9xcomplex<f64>>) -> ()
    return %2 : tensor<8x9xcomplex<f64>>
  }
  func.func private @inputs() -> (tensor<8x9xcomplex<f64>> {mhlo.layout_mode = "default"}) {
    %cst = stablehlo.constant dense<[[(-3.729367044603813,-0.76482505975565629), (3.0851936462633676,-1.644085143919146), (-3.4134245375733467,-0.3842882926289003), (-1.7871130020650865,-6.0768967083141936), (-1.4065736033913279,0.0080819412644190565), (-1.3404621840417978,2.3078638587349998), (2.196803293798955,2.4846467481907006), (2.0838517349413608,1.0377137935187957), (0.19280616336887796,3.6966754763910501)], [(-1.6168468154511246,-0.35773055285056976), (-5.8767418168722605,0.99194727543989702), (-0.4544320179983532,1.6848433399489013), (-2.551148524120892,2.7885964897024351), (-2.1372017240936252,3.5483941621601134), (1.4747363488435821,-3.9101441647709745), (6.9710166314637538,-1.3319049322926795), (-0.37885271796711545,3.0976827740715689), (3.7935538475524018,-3.4672289241471073)], [(3.9823754058359504,-3.417801544646581), (-3.0768834415124271,1.8706764360945149), (4.5897637609658055,-2.4238724822822109), (-3.476473421089485,1.8901164353892239), (2.4512654330700911,1.8107522776357894), (1.3516919637412559,0.31672340617002037), (0.46823505011275957,-2.7834479374417946), (-1.4428420111589031,0.10073798591688779), (2.0242070324403225,2.6492113544535347)], [(-0.67191837189167636,-1.0808002462361312), (-0.23518066191440923,-1.627988210062365), (0.38426989691423941,-0.29679979500575393), (-2.457035641661915,4.9474918878448149), (5.8275401967478837,-1.3499794770961437), (4.2060743205678648,-0.55423932595147662), (0.76726681683786968,-3.1349605531158105), (-3.4497944112229306,0.92307385768749284), (3.3800036627415762,-0.33262777622978063)], [(-1.4754868080833632,0.4687688189856743), (-2.4823347242080285,-0.94508244164596467), (3.1336133470375609,1.4388064811867134), (3.3239283733128424,3.07599849217676), (-2.9043270685825835,1.2700811356726931), (1.541896735464223,1.8186850506284147), (1.7175997382312007,-0.5135346020700432), (-2.2483138664762032,-1.968694739608478), (-0.56965587275140184,-4.0494542660925843)], [(-1.8032298030265723,-3.1783461276839695), (3.9763957083419852,-5.9925454145695536), (4.8802036790753718,-4.121477086738583), (-1.0178925291360787,-2.4978113922145595), (-1.8979331744517229,2.7669383767683762), (-2.5286284899441673,2.3762938148827781), (1.6117852941817865,-1.6699419404017961), (1.4922154103232865,1.7504133254090919), (-1.5122576575937092,-2.6351043846299484)], [(-1.1540235930855993,2.6377054408993272), (-5.6337450471381425,1.6541321536257303), (-3.2669283490656422,-5.357644327085147), (2.0127213299294344,4.4336801097061294), (0.83131370516104974,0.087518638245585117), (0.91158164064839608,1.8699022054913521), (-0.084758364405735475,-1.2204628708123348), (-2.9758268856031882,-0.9155355193615915), (-1.0942067289401074,0.38279381439268734)], [(1.0352534281390766,-3.4974299177696739), (2.0073634575435637,-4.1217862025590257), (2.3883722992996019,2.4001599220442693), (-2.0869484296509464,-4.6632254059351546), (0.064901310410499846,2.5947189157263493), (2.2809890138230111,1.8971786353075295), (1.3321948979710387,-2.2733328879486834), (-2.0863086649228775,-1.4370053291332208), (-2.3377660881993121,-2.0111027649780149)]]> : tensor<8x9xcomplex<f64>>
    return %cst : tensor<8x9xcomplex<f64>>
  }
  func.func private @expected() -> (tensor<8x9xcomplex<f64>> {mhlo.layout_mode = "default"}) {
    %cst = stablehlo.constant dense<[[(-3.729367044603813,-0.76482505975565629), (3.0851936462633676,-1.644085143919146), (-3.4134245375733467,-0.3842882926289003), (-1.7871130020650865,-6.0768967083141936), (-1.4065736033913279,0.0080819412644190565), (-1.3404621840417978,2.3078638587349998), (2.196803293798955,2.4846467481907006), (2.0838517349413608,1.0377137935187957), (0.19280616336887796,3.6966754763910501)], [(-5.346213860054938,-1.1225556126062259), (-2.7915481706088929,-0.65213786847924893), (-3.8678565555716999,1.3005550473200009), (-4.3382615261859785,-3.2883002186117585), (-3.5437753274849531,3.5564761034245325), (0.13427416480178422,-1.6022803060359747), (9.1678199252627088,1.1527418158980212), (1.7049990169742453,4.1353965675903641), (3.9863600109212798,0.22944655224394284)], [(-1.3638384542189872,-4.5403571572528074), (-5.86843161212132,1.218538567615266), (0.72190720539410558,-1.1233174349622099), (-7.814734947275463,-1.3981837832225343), (-1.0925098944148619,5.3672283810603219), (1.4859661285430401,-1.2855568998659543), (9.636054975375469,-1.6307061215437735), (0.26215700581534224,4.2361345535072523), (6.0105670433616023,2.8786579066974771)], [(-2.0357568261106636,-5.6211574034889384), (-6.1036122740357293,-0.40944964244709903), (1.1061771023083451,-1.4201172299679639), (-10.271770588937379,3.5493081046222805), (4.7350303023330218,4.0172489039641786), (5.6920404491109045,-1.8397962258174307), (10.403321792213339,-4.7656666746595837), (-3.187637405407588,5.1592084111947454), (9.3905707061031798,2.5460301304676967)], [(-3.5112436341940265,-5.1523885845032638), (-8.5859469982437577,-1.3545320840930639), (4.2397904493459055,0.018689251218749758), (-6.9478422156245365,6.6253065967990405), (1.8307032337504383,5.2873300396368714), (7.2339371845751277,-0.021111175189016507), (12.120921530444537,-5.2792012767296264), (-5.4359512718837912,3.1905136715862668), (8.8209148333517771,-1.5034241356248872)], [(-5.3144734372205988,-8.3307347121872333), (-4.6095512899017725,-7.3470774986626175), (9.1199941284212773,-4.1027878355198339), (-7.9657347447606153,4.1274952045844815), (-0.067229940701284185,8.0542684164052467), (4.7053086946309604,2.3551826396937612), (13.732706824626325,-6.9491432171314234), (-3.9437358615605049,4.9409269969953593), (7.3086571757580678,-4.1385285202548356)], [(-6.4684970303061986,-5.693029271287906), (-10.243296337039915,-5.692945345036887), (5.8530657793556351,-9.4604321626049809), (-5.9530134148311804,8.5611753142906117), (0.76408376445976555,8.1417870546508322), (5.616890335279356,4.2250848451851137), (13.64794846022059,-8.1696060879437589), (-6.9195627471636936,4.025391477633768), (6.2144504468179607,-3.7557347058621477)], [(-5.4332436021671215,-9.1904591890575809), (-8.2359328794963513,-9.8147315475959118), (8.2414380786552357,-7.0602722405607103), (-8.0399618444821268,3.8979499083554559), (0.8289850748702654,10.736505970377181), (7.8978793491023671,6.1222634804926432), (14.980143358191629,-10.442938975892442), (-9.0058714120865719,2.5883861485005468), (3.8766843586186477,-5.7668374708401631)]]> : tensor<8x9xcomplex<f64>>
    return %cst : tensor<8x9xcomplex<f64>>
  }
  func.func private @cumsum(%arg0: tensor<8x9xcomplex<f64>>) -> tensor<8x9xcomplex<f64>> {
    %cst = stablehlo.constant dense<(0.000000e+00,0.000000e+00)> : tensor<complex<f64>>
    %0 = stablehlo.broadcast_in_dim %cst, dims = [] : (tensor<complex<f64>>) -> tensor<complex<f64>>
    %1 = "stablehlo.reduce_window"(%arg0, %0) <{padding = dense<[[7, 0], [0, 0]]> : tensor<2x2xi64>, window_dimensions = array<i64: 8, 1>}> ({
    ^bb0(%arg1: tensor<complex<f64>>, %arg2: tensor<complex<f64>>):
      %2 = stablehlo.add %arg1, %arg2 : tensor<complex<f64>>
      stablehlo.return %2 : tensor<complex<f64>>
    }) : (tensor<8x9xcomplex<f64>>, tensor<complex<f64>>) -> tensor<8x9xcomplex<f64>>
    return %1 : tensor<8x9xcomplex<f64>>
  }
}
