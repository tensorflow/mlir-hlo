// RUN: stablehlo-opt -inline %s | stablehlo-translate --interpret
// RUN: stablehlo-translate --serialize --target=current %s | stablehlo-translate --deserialize | stablehlo-opt > %t.0
// RUN: stablehlo-opt %s > %t.1
// RUN: diff %t.0 %t.1

module @jit_main attributes {mhlo.num_partitions = 1 : i32, mhlo.num_replicas = 1 : i32} {
  func.func public @main() -> (tensor<4x6xcomplex<f64>> {jax.result_info = "", mhlo.layout_mode = "default"}) {
    %0:2 = call @inputs() : () -> (tensor<4x3xf64>, tensor<3x6xcomplex<f64>>)
    %1 = call @expected() : () -> tensor<4x6xcomplex<f64>>
    %2 = stablehlo.convert %0#0 : (tensor<4x3xf64>) -> tensor<4x3xcomplex<f64>>
    %3 = stablehlo.convert %0#1 : tensor<3x6xcomplex<f64>>
    %4 = stablehlo.dot_general %2, %3, contracting_dims = [1] x [0] : (tensor<4x3xcomplex<f64>>, tensor<3x6xcomplex<f64>>) -> tensor<4x6xcomplex<f64>>
    stablehlo.custom_call @check.expect_close(%4, %1) {has_side_effect = true} : (tensor<4x6xcomplex<f64>>, tensor<4x6xcomplex<f64>>) -> ()
    return %4 : tensor<4x6xcomplex<f64>>
  }
  func.func private @inputs() -> (tensor<4x3xf64> {mhlo.layout_mode = "default"}, tensor<3x6xcomplex<f64>> {mhlo.layout_mode = "default"}) {
    %cst = stablehlo.constant dense<[[-0.89825024827570332, -2.5245810254908507, 5.164459648018755], [-1.0527164587586098, 2.8261515069750081, 1.6466189692855533], [4.0548074629035646, -3.9451701219106496, 6.7099504551770481], [1.0058345677341527, -1.1133009380872523, 2.8242823678082201]]> : tensor<4x3xf64>
    %cst_0 = stablehlo.constant dense<[[(0.44007951419621261,-0.14329354506260919), (5.0993573998546751,1.4378938233300973), (2.4588540250673998,5.1754074173983362), (0.46592987296609262,-6.0932013151388791), (1.0655352593954197,0.87226311791448785), (0.58355272758396648,-0.19714935656454236)], [(-1.04687259017969,-0.91787269610492894), (3.5640839991092026,-0.79015195241089619), (2.0945743212848384,-0.42830492452823948), (-0.072957280957986301,-1.3987085516093674), (-3.5412075747713567,0.1710076155424799), (-3.5022141354692624,2.2235395410375838)], [(4.2160429330294384,0.093532136341324206), (-2.0935815024107187,-4.3369883372582558), (-3.119059557090667,0.32419676957804811), (1.5303319695030149,5.0752499966244127), (-5.6309159035205116,2.4565008106047319), (-3.8369417021048684,-0.9207598518880229)]]> : tensor<3x6xcomplex<f64>>
    return %cst, %cst_0 : tensor<4x3xf64>, tensor<3x6xcomplex<f64>>
  }
  func.func private @expected() -> (tensor<4x6xcomplex<f64>> {mhlo.layout_mode = "default"}) {
    %cst = stablehlo.constant dense<[[(24.02119674633148,2.9290003987591851), (-24.390535076911284,-21.694987119187481), (-23.604846048848586,-1.8932193775138242), (7.6690026476784663,35.21529647487624), (-21.097689825824965,11.471266168052093), (-11.49828362114371,-10.191643376842043)], [(3.5203167727445677,-2.2891880400494542), (1.2571328855336228,-10.888150890511891), (-1.804794360339895,-6.1248626264086079), (1.8231932748648592,10.818453948334859), (-20.40166857009314,3.6099685225799893), (-16.830084308315428,4.9754613589356733)], [(34.203967360184762,3.6677322013021132), (-7.4318334193732429,-20.153310387560929), (-19.222007474245306,24.850360672546397), (12.445536506442654,14.86606104645854), (-19.491960088636073,19.345203596937829), (-9.5626641979346907,-15.749897431777725)], [(13.51542714231258,1.1419000961533854), (-4.7516534364532959,-9.9229194682210213), (-8.6677960925897181,6.5980591768113275), (4.8719613800606911,9.7623701093725437), (-10.889114588929749,7.6248213832519998), (-6.3506310076629706,-5.2742541094234543)]]> : tensor<4x6xcomplex<f64>>
    return %cst : tensor<4x6xcomplex<f64>>
  }
}
