// RUN: stablehlo-opt -inline %s | stablehlo-translate --interpret
// RUN: stablehlo-translate --serialize --target=current %s | stablehlo-translate --deserialize | stablehlo-opt > %t.0
// RUN: stablehlo-opt %s > %t.1
// RUN: diff %t.0 %t.1

module @jit_main attributes {mhlo.num_partitions = 1 : i32, mhlo.num_replicas = 1 : i32} {
  func.func public @main() -> (tensor<5x6x7xbf16> {jax.result_info = "", mhlo.layout_mode = "default"}) {
    %c = stablehlo.constant dense<[[[0], [1]], [[2], [3]]]> : tensor<2x2x1xi64>
    %0:2 = call @inputs() : () -> (tensor<5x6x7xbf16>, tensor<5x2x2x7xbf16>)
    %1 = call @expected() : () -> tensor<5x6x7xbf16>
    %2 = "stablehlo.scatter"(%0#0, %c, %0#1) <{scatter_dimension_numbers = #stablehlo.scatter<update_window_dims = [0, 3], inserted_window_dims = [1], scatter_dims_to_operand_dims = [1], index_vector_dim = 2>, unique_indices = true}> ({
    ^bb0(%arg0: tensor<bf16>, %arg1: tensor<bf16>):
      %3 = stablehlo.add %arg0, %arg1 : tensor<bf16>
      stablehlo.return %3 : tensor<bf16>
    }) : (tensor<5x6x7xbf16>, tensor<2x2x1xi64>, tensor<5x2x2x7xbf16>) -> tensor<5x6x7xbf16>
    stablehlo.custom_call @check.expect_close(%2, %1) {has_side_effect = true} : (tensor<5x6x7xbf16>, tensor<5x6x7xbf16>) -> ()
    return %2 : tensor<5x6x7xbf16>
  }
  func.func private @inputs() -> (tensor<5x6x7xbf16> {mhlo.layout_mode = "default"}, tensor<5x2x2x7xbf16> {mhlo.layout_mode = "default"}) {
    %cst = stablehlo.constant dense<"0xACBFAD4033403F3FCC3FB1BF8F40984066BED13E963F99BF59401D4092BDB13E85C05C3F924010BFD0BFF1BF0040DC3FC8C009C0B7BEEABE32BFA43F244036C0FD3F22BF40BFADC0CEBE21C0973F63BFD83FEA3EAC3FABBF1FC00840123F0FC00FC0CC3EB13F43C0BA4029C030BFE0BFA2BF8ABEE6BB54C0EB3F6DBF48404BBF19401F3FD4BF0EC075BE10C070C01C3D583F0CC0A1405CC02F4092BF8DC046C032C022C0B43F3040BBC03040993F0840BEBD313FC54086BE533E97C0A140AD3F7240893E613F29BF44BF30BF2F3E7B3FC0BEAFC0EF3FE9C0A6BF3A3FE93F024000BE26408ABF0E4020409FBF6BC05EBFD0BDA6BF04BF39C01AC0E03FCF3F8FBFCCBFB8C042BF04404D3FFA3E7040A93FBF3E41BFCA40B7407BC0BA3F17C093C026C010C05BBF19C1A740EC3F993F3BBFB7BF974029C082BF41BF943F6B3FD0401540B13F6EC0B6C0C1400540973843BE6FBF18BF66405DBFB5BFA040ECBE7540314060C03DBE06408AC0B7C0FBBF14C01C408CC0443EC4BFAFBFACBDADBF77C0C24056C0123F924083C084BF4E40A2BF9F3F8DBE593F3DC06F3F5B409540E24014C04CBF"> : tensor<5x6x7xbf16>
    %cst_0 = stablehlo.constant dense<"0x10C098BEC3C09CC0CB3F8D400DBFE83FDA3FDBBFD63F5EBF854084C0873FB43FAB3FF43C5A4090BF6E40ACBA3140D340F64014C07C40B53F8FC065C0114086BFA6403A3F46C0A0BE9B3E6B40C73F5F3F1B3F063F83BFB03FBDBE973F5CC073BF86BEAEC07240B13D92BE27C0BC3FA03F853FFB3EF03FDABFA1BDBA3F9C4000C09EC01D3CC1C01BC06F3F993FAD400EBEAA3FE5BEE13FDDBF36C01DBEBFC0713F03BE794082C093C0BC404B3EB1C01D402AC059C06FC05BBF7ABE8D3F974078BF64409D409DBF693F10C18A404B4085404DC017408A403A4029BF38BF47BF96BF58C047BF49C0C03FC4BE7CC062401BC0504087C044BE2BC03040FD3F2640AA3D5E3F26BE2240ACBE1EC055C092BBD5BF6D3ECD3F5240713F"> : tensor<5x2x2x7xbf16>
    return %cst, %cst_0 : tensor<5x6x7xbf16>, tensor<5x2x2x7xbf16>
  }
  func.func private @expected() -> (tensor<5x6x7xbf16> {mhlo.layout_mode = "default"}) {
    %cst = stablehlo.constant dense<"0x66C0A44053C084C04C4042407B40D240BD3FA7BF364004C0F240D6BF7C3FE03F34C0643FFF40D8BF0640F1BF98400541B83F8EC06540753F32BFA43F244036C0FD3F22BF40BFADC0CEBE21C0973F63BFD83FEA3E48C09DC060BE8A3FB840C1BFAAC0B03DD83F203FEC40E2BFA8BD9DBF12C08E3FC1BE08C0CDBFF0BF3740C7C0C640353FF8BF9AC09D3F80BF70C01C3D583F0CC0A1405CC02F4092BF8DC046C032C022C0B43F30409AC04F404440D83E30BE0940304111C097C097C080BF89BF9740BB3FC9404CBF103F91BFF73F3FBF4EC0B4C083C0CBC0B6BF944010C024C000BE26408ABF0E4020409FBF6BC05EBFD0BDA6BF04BF39C01AC0E03FF0406BBFE4C053C05AC0AABF3CC0BCBE60401B40A340DCBF1E412A41A5C0174036C190BE143FF43F82C0E6C018419840093FBABF0DC0634029C082BF41BF943F6B3FD0401540B13F6EC0B6C0C1400540973843BE8AC0B0BFE83E233FE6BF883F4440B43FC040F7C0C0BE14BFC8BF70C0223F0FC0544091C02E40EFBF76C05AC0AEBFB1C0C940DFBF7640B04083C084BF4E40A2BF9F3F8DBE593F3DC06F3F5B409540E24014C04CBF"> : tensor<5x6x7xbf16>
    return %cst : tensor<5x6x7xbf16>
  }
}
