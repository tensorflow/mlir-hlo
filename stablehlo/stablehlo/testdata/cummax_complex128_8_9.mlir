// RUN: stablehlo-opt -inline %s | stablehlo-translate --interpret
// RUN: stablehlo-translate --serialize --target=current %s | stablehlo-translate --deserialize | stablehlo-opt > %t.0
// RUN: stablehlo-opt %s > %t.1
// RUN: diff %t.0 %t.1

module @jit_main attributes {mhlo.num_partitions = 1 : i32, mhlo.num_replicas = 1 : i32} {
  func.func public @main() -> (tensor<8x9xcomplex<f64>> {jax.result_info = "", mhlo.layout_mode = "default"}) {
    %0 = call @inputs() : () -> tensor<8x9xcomplex<f64>>
    %1 = call @expected() : () -> tensor<8x9xcomplex<f64>>
    %2 = call @cummax(%0) : (tensor<8x9xcomplex<f64>>) -> tensor<8x9xcomplex<f64>>
    stablehlo.custom_call @check.expect_close(%2, %1) {has_side_effect = true} : (tensor<8x9xcomplex<f64>>, tensor<8x9xcomplex<f64>>) -> ()
    return %2 : tensor<8x9xcomplex<f64>>
  }
  func.func private @inputs() -> (tensor<8x9xcomplex<f64>> {mhlo.layout_mode = "default"}) {
    %cst = stablehlo.constant dense<[[(-1.297454858483249,0.58973079261056327), (0.41359658263325705,1.7717698706643916), (-3.3070777845003696,-6.3137193428668468), (2.398397118042749,1.2332563454807886), (-3.0689415314389086,-0.40884890634441373), (4.7918926507820405,2.9919636484706924), (0.87374016821319933,-1.3055943563758132), (0.86491686885406516,3.4060325142741177), (-0.30278090915411138,0.24981900523313683)], [(2.6116323688812044,4.3213500344975637), (-0.86979977948720844,-5.8821325701949059), (-3.4836929604883737,-0.51511451980216427), (-0.34394507485465242,0.02955140559514606), (2.9582614864582899,0.65514293063258244), (-3.5751320148492107,-4.884455943014796), (-1.6671901855117985,-1.328907943305524), (5.4648704015695992,3.7314221037650377), (3.5591791409690874,-2.6020054264793622)], [(2.4363760246523145,3.242488996749219), (-2.8841512434816634,-0.1676976827962236), (-2.0138756057877178,1.5920347830414152), (2.0548755681479798,-3.9433115267706706), (3.1529707854032241,-4.9921041977535392), (1.5958684848681957,-2.3328766175473148), (-2.8968589937153109,-1.12733536114093), (-3.1688209154499454,1.5712072443572802), (-1.1811706363447114,-3.2713293636598264)], [(-2.480753236613388,-0.99753638798008226), (-5.613282456851465,1.7668791844869487), (-1.1504858571152676,1.3222012582029483), (-5.3580570431742638,0.63790421204502568), (-2.2676722091516792,-1.1338167811216853), (1.9629260117637826,1.9411427508788872), (4.1708347589655679,2.6910821757659922), (-0.64951114696877787,-0.30559487102170479), (-0.81756609043008166,3.1660486404761823)], [(0.15981706892848208,5.8446049781195981), (-2.4752760032304129,-1.3504030727522442), (-0.88076631066901712,-1.2676584169329999), (0.54350830799217187,-0.0083101071685670116), (5.9304236435797968,3.2279309276149837), (-1.6081157059892039,-2.6690707687657076), (4.5363064265771387,-4.1531248822275089), (-2.5582658139325467,-0.088698403359143224), (0.54707901228067346,-0.69506968513469625)], [(3.5227526266022018,1.398181862799039), (-2.7478877958204522,-2.419126179332824), (0.26793619510261174,-2.2427062201677113), (4.7569077530232988,5.3563305478212753), (-1.4497290454419429,1.3035602562392932), (2.6348703841189405,8.5812672895638116), (1.4467530370733233,-1.7143201292379948), (-1.9118188609714823,0.44090113445855833), (4.4382571165585185,0.68025214018039104)], [(-5.2296436880921542,-3.9938884068175806), (-2.9901316195499228,1.2597831983661731), (2.0457591751020958,-0.66833053044956425), (-0.76065144437459975,-4.6969179978479065), (3.7499550479306452,-1.2705799692288213), (2.3800147772622493,8.3204803471558115), (0.4418396157433862,-4.0081923065574188), (-5.4065541010993332,-0.57315716856712873), (1.4214185470966498,-2.4336491749721159)], [(1.6235062888731959,5.2079321356681616), (-3.0131424849427657,-2.0600011800244138), (1.9640044808127717,0.50726060690754959), (0.87482461676754908,1.7425714781192165), (1.2652596027832588,-3.726390690435621), (5.8384304548115127,1.2041763096118032), (1.3649561941197632,-4.118572382386505), (-1.2346711090783937,-0.49972591215384937), (-3.7575575250711117,2.5186521946226419)]]> : tensor<8x9xcomplex<f64>>
    return %cst : tensor<8x9xcomplex<f64>>
  }
  func.func private @expected() -> (tensor<8x9xcomplex<f64>> {mhlo.layout_mode = "default"}) {
    %cst = stablehlo.constant dense<[[(-1.297454858483249,0.58973079261056327), (0.41359658263325705,1.7717698706643916), (-3.3070777845003696,-6.3137193428668468), (2.398397118042749,1.2332563454807886), (-3.0689415314389086,-0.40884890634441373), (4.7918926507820405,2.9919636484706924), (0.87374016821319933,-1.3055943563758132), (0.86491686885406516,3.4060325142741177), (-0.30278090915411138,0.24981900523313683)], [(2.6116323688812044,4.3213500344975637), (0.41359658263325705,1.7717698706643916), (-3.3070777845003696,-6.3137193428668468), (2.398397118042749,1.2332563454807886), (2.9582614864582899,0.65514293063258244), (4.7918926507820405,2.9919636484706924), (0.87374016821319933,-1.3055943563758132), (5.4648704015695992,3.7314221037650377), (3.5591791409690874,-2.6020054264793622)], [(2.6116323688812044,4.3213500344975637), (0.41359658263325705,1.7717698706643916), (-2.0138756057877178,1.5920347830414152), (2.398397118042749,1.2332563454807886), (3.1529707854032241,-4.9921041977535392), (4.7918926507820405,2.9919636484706924), (0.87374016821319933,-1.3055943563758132), (5.4648704015695992,3.7314221037650377), (3.5591791409690874,-2.6020054264793622)], [(2.6116323688812044,4.3213500344975637), (0.41359658263325705,1.7717698706643916), (-1.1504858571152676,1.3222012582029483), (2.398397118042749,1.2332563454807886), (3.1529707854032241,-4.9921041977535392), (4.7918926507820405,2.9919636484706924), (4.1708347589655679,2.6910821757659922), (5.4648704015695992,3.7314221037650377), (3.5591791409690874,-2.6020054264793622)], [(2.6116323688812044,4.3213500344975637), (0.41359658263325705,1.7717698706643916), (-0.88076631066901712,-1.2676584169329999), (2.398397118042749,1.2332563454807886), (5.9304236435797968,3.2279309276149837), (4.7918926507820405,2.9919636484706924), (4.5363064265771387,-4.1531248822275089), (5.4648704015695992,3.7314221037650377), (3.5591791409690874,-2.6020054264793622)], [(3.5227526266022018,1.398181862799039), (0.41359658263325705,1.7717698706643916), (0.26793619510261174,-2.2427062201677113), (4.7569077530232988,5.3563305478212753), (5.9304236435797968,3.2279309276149837), (4.7918926507820405,2.9919636484706924), (4.5363064265771387,-4.1531248822275089), (5.4648704015695992,3.7314221037650377), (4.4382571165585185,0.68025214018039104)], [(3.5227526266022018,1.398181862799039), (0.41359658263325705,1.7717698706643916), (2.0457591751020958,-0.66833053044956425), (4.7569077530232988,5.3563305478212753), (5.9304236435797968,3.2279309276149837), (4.7918926507820405,2.9919636484706924), (4.5363064265771387,-4.1531248822275089), (5.4648704015695992,3.7314221037650377), (4.4382571165585185,0.68025214018039104)], [(3.5227526266022018,1.398181862799039), (0.41359658263325705,1.7717698706643916), (2.0457591751020958,-0.66833053044956425), (4.7569077530232988,5.3563305478212753), (5.9304236435797968,3.2279309276149837), (5.8384304548115127,1.2041763096118032), (4.5363064265771387,-4.1531248822275089), (5.4648704015695992,3.7314221037650377), (4.4382571165585185,0.68025214018039104)]]> : tensor<8x9xcomplex<f64>>
    return %cst : tensor<8x9xcomplex<f64>>
  }
  func.func private @cummax(%arg0: tensor<8x9xcomplex<f64>>) -> tensor<8x9xcomplex<f64>> {
    %cst = stablehlo.constant dense<(0xFFF0000000000000,0.000000e+00)> : tensor<complex<f64>>
    %0 = stablehlo.broadcast_in_dim %cst, dims = [] : (tensor<complex<f64>>) -> tensor<complex<f64>>
    %1 = "stablehlo.reduce_window"(%arg0, %0) <{padding = dense<[[7, 0], [0, 0]]> : tensor<2x2xi64>, window_dimensions = array<i64: 8, 1>}> ({
    ^bb0(%arg1: tensor<complex<f64>>, %arg2: tensor<complex<f64>>):
      %2 = stablehlo.real %arg1 : (tensor<complex<f64>>) -> tensor<f64>
      %3 = stablehlo.real %arg2 : (tensor<complex<f64>>) -> tensor<f64>
      %4 = stablehlo.compare  EQ, %2, %3,  FLOAT : (tensor<f64>, tensor<f64>) -> tensor<i1>
      %5 = stablehlo.compare  GT, %2, %3,  FLOAT : (tensor<f64>, tensor<f64>) -> tensor<i1>
      %6 = stablehlo.imag %arg1 : (tensor<complex<f64>>) -> tensor<f64>
      %7 = stablehlo.imag %arg2 : (tensor<complex<f64>>) -> tensor<f64>
      %8 = stablehlo.compare  GT, %6, %7,  FLOAT : (tensor<f64>, tensor<f64>) -> tensor<i1>
      %9 = stablehlo.select %4, %8, %5 : tensor<i1>, tensor<i1>
      %10 = stablehlo.select %9, %arg1, %arg2 : tensor<i1>, tensor<complex<f64>>
      stablehlo.return %10 : tensor<complex<f64>>
    }) : (tensor<8x9xcomplex<f64>>, tensor<complex<f64>>) -> tensor<8x9xcomplex<f64>>
    return %1 : tensor<8x9xcomplex<f64>>
  }
}
