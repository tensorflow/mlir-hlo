// RUN: stablehlo-opt -inline %s | stablehlo-translate --interpret
// RUN: stablehlo-translate --serialize --target=current %s | stablehlo-translate --deserialize | stablehlo-opt > %t.0
// RUN: stablehlo-opt %s > %t.1
// RUN: diff %t.0 %t.1

module @jit_main attributes {mhlo.num_partitions = 1 : i32, mhlo.num_replicas = 1 : i32} {
  func.func public @main() -> (tensor<3x5x40xbf16> {jax.result_info = "", mhlo.layout_mode = "default"}) {
    %c = stablehlo.constant dense<1> : tensor<2x1xi64>
    %0:2 = call @inputs() : () -> (tensor<3x5x40xbf16>, tensor<3x5x2xbf16>)
    %1 = call @expected() : () -> tensor<3x5x40xbf16>
    %2 = "stablehlo.scatter"(%0#0, %c, %0#1) <{scatter_dimension_numbers = #stablehlo.scatter<update_window_dims = [0, 1], inserted_window_dims = [2], scatter_dims_to_operand_dims = [2], index_vector_dim = 1>}> ({
    ^bb0(%arg0: tensor<bf16>, %arg1: tensor<bf16>):
      %3 = stablehlo.add %arg0, %arg1 : tensor<bf16>
      stablehlo.return %3 : tensor<bf16>
    }) : (tensor<3x5x40xbf16>, tensor<2x1xi64>, tensor<3x5x2xbf16>) -> tensor<3x5x40xbf16>
    stablehlo.custom_call @check.expect_close(%2, %1) {has_side_effect = true} : (tensor<3x5x40xbf16>, tensor<3x5x40xbf16>) -> ()
    return %2 : tensor<3x5x40xbf16>
  }
  func.func private @inputs() -> (tensor<3x5x40xbf16> {mhlo.layout_mode = "default"}, tensor<3x5x2xbf16> {mhlo.layout_mode = "default"}) {
    %cst = stablehlo.constant dense<"0x96406DBF8D400E3F4840A04080BF7EC0BA4094C0DABE2F3F94BF5E404D409540174177C0C9C08140B14095406D400E409BC0203EE6BEE03E6F3EF83F223F8D4095C08ABF0CC012C062C065C06FBF0EBE90BD21C04C3F81C00D40AB3F6AC098BE093FAEBFAD3FE23EB74020C0684004C09BC0D5BFA7C021C017C066BF5140013F7FC014C05B40933F7D3FDCBE743FA1C0A9C0DBBFC4BE6F4011BF03C05C40A8BF83C043408240813DC9BFE8BF044022BEC53F11C105C034407DC04F40F73EE6405ABE37C077C02BBF68BF78BFA4BF2A401E3FB8BF7E3F5C3F5840223F61C05B404940073F1B3F37C0394017400EC0BEC005BE184030402E3F573F05C091BFC2BF3CBF3BBF5E408D40D0BF9AC068BFADBF97BEA1404140AF3FE3BD3140A3BC6A3F24BF893E92C0FD3D5040C8BE0DBF17C00F3F2F3FB6BFF73C88BF804018BF6F409540ABBE144099BB334025C09A40F83F60BF38C04F40D63F074144C0FCBEC34085BF494032404C40C3BD9EBF7640E5BE253E82C0D2BE3BC0104122401FBE9CC0D2C002C1753FBABE1C40A3C00840793F3A40DB3F0AC011408DC0B0C0124008C030C09540183E8ABE2EBE943FACC00641814076407BC025406DBF023F83BF7A40803E03BF7E40553FE73F30BFB0BF42C0BBBFA5C0B3BFC7BECE3F8BC0043E45BF43BF96C08E3F2840D13F8DC0B1BFB0C0D33F243F3EC086C08F409E40EC3F16C0AABE47402C401A40FEC0F33E0BBF85C09EC03CC0CDC0D1BF4FC05C4071BFB2C014BD90BF30BF12BF48C093C00E4037C01DC013409EC04AC07FC0C6BEAE407ABF62BFECBF3B3FBFBFD93F303E8F3D124023BE003FF1BE704058BDA0C030BFD93FBD3C3E40D0BED73F31BFDEBFCF3F71BE3CC04AC030BFBA4072400040FA3F32409940F6BF41407BC05640033F393F4F4075BFE2BEC5BF7D3F963FDEBF6BBF93C06EBF5DC068C02840B14036C0543E51401DC0983F973D6540B5BF56C0DEBE8EBFEA3F004084C0B740273F3CC00A402E40254038C020C049C03EBF7EC09BBFAF3E29C0CABFDF3F90C04740D43E9A40C6BD3B3D884025C01240353DB43FB23FBF3F523F0F4098C0D9BF16C04E3FBA404F403C3FC1BF40407D3F3CBE673F89C09AC0EC3F0F40DABEC1BED13EEABD01C0524030C09C3F1E40F1BD53BE1FC082C080BE7ABF2DC06140F43F12BFB93E35C027C0B03D9B3FF4BEA6C0DB3F9BBF5F3F27C043400E407C40013FC3BF00BFD7BFCB3F43408FBEB23F35408940BBBFE13F1740ECBF5D4079407D3FDB3FF83F4CBF6540773EAF3FE73E02C0A1C0BD3FBFBFD540A43F354059C085404640D9BBF23E3CBE3340674059C03F3FF2BF4EC0A13E6BBFAFBFEE3F3E3C28C058BFF53E5440CA3E0E4057C097C0164020405FC0F93FD3C0813F5A40103FF43F6940DEBF4D3E7B40BCBF314042C0F6BEEA3E47BF88405BC0D63FC03FFC40824036C087BF8FBF84BF92C089C074405740374053400BC0D53F06BF88C0DB4002C0904090C0943F6E400D401640663F283FD53F47401CC09D40B5BF2C40B83F9840C3BF2AC09B3F80408E402AC057C072C03FC0FA3FB9C0C33F67C01441903C9CBDFEBF79409EBF87BF32BF523F1DC03C4004C0083FAAC00CBFF53E1B3FCEBF2140F13F40C08AC00F3F6A3F84BF84C007C084BF233F32C03B4092BFDABFF240C6406DBFF83FBCBFD83F"> : tensor<3x5x40xbf16>
    %cst_0 = stablehlo.constant dense<[[[2.187500e+00, -3.750000e+00], [-6.914060e-01, -8.398430e-01], [2.812500e+00, -4.500000e+00], [2.953130e+00, -2.625000e+00], [3.222660e-01, 1.601560e-01]], [[1.703130e+00, -1.226560e+00], [-3.750000e+00, -2.062500e+00], [6.343750e+00, -4.625000e+00], [4.150390e-02, 2.718750e+00], [-4.343750e+00, -8.125000e-01]], [[7.890630e-01, -1.710940e+00], [3.007810e-01, -3.984380e-01], [2.750000e+00, 1.898440e+00], [-6.171880e-01, -2.750000e+00], [3.984380e+00, -5.281250e+00]]]> : tensor<3x5x2xbf16>
    return %cst, %cst_0 : tensor<3x5x40xbf16>, tensor<3x5x2xbf16>
  }
  func.func private @expected() -> (tensor<3x5x40xbf16> {mhlo.layout_mode = "default"}) {
    %cst = stablehlo.constant dense<"0x96401FC08D400E3F4840A04080BF7EC0BA4094C0DABE2F3F94BF5E404D409540174177C0C9C08140B14095406D400E409BC0203EE6BEE03E6F3EF83F223F8D4095C08ABF0CC012C062C065C06FBF0EBE90BD81C04C3F81C00D40AB3F6AC098BE093FAEBFAD3FE23EB74020C0684004C09BC0D5BFA7C021C017C066BF5140013F7FC014C05B40933F7D3FDCBE743FA1C0A9C0DBBFC4BE6F4011BF03C05C40A8BF83C0B03F8240813DC9BFE8BF044022BEC53F11C105C034407DC04F40F73EE6405ABE37C077C02BBF68BF78BFA4BF2A401E3FB8BF7E3F5C3F5840223F61C05B404940073F1B3F37C0394017400EC0BEC005BE2C4030402E3F573F05C091BFC2BF3CBF3BBF5E408D40D0BF9AC068BFADBF97BEA1404140AF3FE3BD3140A3BC6A3F24BF893E92C0FD3D5040C8BE0DBF17C00F3F2F3FB6BFF73C88BF804018BF6F409540183E144099BB334025C09A40F83F60BF38C04F40D63F074144C0FCBEC34085BF494032404C40C3BD9EBF7640E5BE253E82C0D2BE3BC0104122401FBE9CC0D2C002C1753FBABE1C40A3C00840793F3A400C400AC011408DC0B0C0124008C030C09540183E8ABE2EBE943FACC00641814076407BC025406DBF023F83BF7A40803E03BF7E40553FE73F30BFB0BF42C0BBBFA5C0B3BFC7BECE3F8BC0043E45BF43BF28C18E3F2840D13F8DC0B1BFB0C0D33F243F3EC086C08F409E40EC3F16C0AABE47402C401A40FEC0F33E0BBF85C09EC03CC0CDC0D1BF4FC05C4071BFB2C014BD90BF30BF12BF48C093C00E4037C01DC080409EC04AC07FC0C6BEAE407ABF62BFECBF3B3FBFBFD93F303E8F3D124023BE003FF1BE704058BDA0C030BFD93FBD3C3E40D0BED73F31BFDEBFCF3F71BE3CC04AC030BFBA4072400040FA3F32409940563F41407BC05640033F393F4F4075BFE2BEC5BF7D3F963FDEBF6BBF93C06EBF5DC068C02840B14036C0543E51401DC0983F973D6540B5BF56C0DEBE8EBFEA3F004084C0B740273F3CC00A402E40254000C120C049C03EBF7EC09BBFAF3E29C0CABFDF3F90C04740D43E9A40C6BD3B3D884025C01240353DB43FB23FBF3F523F0F4098C0D9BF16C04E3FBA404F403C3FC1BF40407D3F3CBE673F89C09AC0EC3FA93FDABEC1BED13EEABD01C0524030C09C3F1E40F1BD53BE1FC082C080BE7ABF2DC06140F43F12BFB93E35C027C0B03D9B3FF4BEA6C0DB3F9BBF5F3F27C043400E407C40013FC3BF00BFD7BFCB3F4340C1BEB23F35408940BBBFE13F1740ECBF5D4079407D3FDB3FF83F4CBF6540773EAF3FE73E02C0A1C0BD3FBFBFD540A43F354059C085404640D9BBF23E3CBE3340674059C03F3FF2BF4EC0A13E6BBFAFBFD1403E3C28C058BFF53E5440CA3E0E4057C097C0164020405FC0F93FD3C0813F5A40103FF43F6940DEBF4D3E7B40BCBF314042C0F6BEEA3E47BF88405BC0D63FC03FFC40824036C087BF8FBF84BF92C0F5C074405740374053400BC0D53F06BF88C0DB4002C0904090C0943F6E400D401640663F283FD53F47401CC09D40B5BF2C40B83F9840C3BF2AC09B3F80408E402AC057C072C03FC0FA3FB9C0C33F67C0FF40903C9CBDFEBF79409EBF87BF32BF523F1DC03C4004C0083FAAC00CBFF53E1B3FCEBF2140F13F40C08AC00F3F6A3F84BF84C007C084BF233F32C03B4092BFDABFF240C6406DBFF83FBCBFD83F"> : tensor<3x5x40xbf16>
    return %cst : tensor<3x5x40xbf16>
  }
}
